<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Huella y VisualizaciÃ³n</title>
</head>
<body>

<h2>ğŸ“ Registrar Usuario y Huella</h2>
<form action="" method="get">
    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Apellido:</label><br>
    <input type="text" name="apellido" required><br><br>

    <label>ID de Huella (ej. 4):</label><br>
    <input type="number" name="id" required><br><br>

    <input type="submit" value="Enviar al ESP32">
</form>

<?php
// ENVIAR DATOS AL ESP32
if (isset($_GET['nombre']) && isset($_GET['apellido']) && isset($_GET['id'])) {
    $nombre = urlencode($_GET['nombre']);
    $apellido = urlencode($_GET['apellido']);
    $id = intval($_GET['id']);

    $esp_ip = "192.168.197.143"; // AJUSTA segÃºn la IP real del ESP32

    $url = "http://$esp_ip/enroll?nombre=$nombre&apellido=$apellido&id=$id";

    echo "<p>ğŸ”„ Enviando a ESP32: <a href='$url' target='_blank'>$url</a></p>";
    echo "<iframe src='$url' width='100%' height='120'></iframe><hr>";
}
?>

<!-- CONSULTAR Y MOSTRAR USUARIOS -->
<h2>ğŸ‘¤ Usuarios Registrados</h2>
<?php
$conn = new mysqli("localhost", "root", "", "dots");
if ($conn->connect_error) {
    die("âŒ Error de conexiÃ³n: " . $conn->connect_error);
}

$result = $conn->query("SELECT * FROM usuarios ORDER BY id DESC");
echo "<table border='1' cellpadding='8'><tr>
        <th>ID</th><th>Nombre</th><th>Apellido</th><th>ID Huella</th><th>Gabinete</th><th>Fecha</th>
      </tr>";
while ($row = $result->fetch_assoc()) {
    echo "<tr>
            <td>{$row['id']}</td><td>{$row['nombre']}</td><td>{$row['apellido']}</td>
            <td>{$row['idhuella']}</td><td>{$row['gabinete']}</td><td>{$row['fecha_registro']}</td>
          </tr>";
}
echo "</table><hr>";
?>

<!-- CONSULTAR Y MOSTRAR REGISTROS DE TEMPERATURA -->
<h2>ğŸŒ¡ Registros de Temperatura y Humedad</h2>
<?php
$result2 = $conn->query("SELECT * FROM registro ORDER BY id DESC LIMIT 20");
echo "<table border='1' cellpadding='8'><tr>
        <th>ID</th><th>Temp (Â°C)</th><th>Humedad (%)</th><th>ID Huella</th><th>Gabinete</th><th>Fecha</th>
      </tr>";
while ($row = $result2->fetch_assoc()) {
    echo "<tr>
            <td>{$row['id']}</td><td>{$row['temperatura']}</td><td>{$row['humedad']}</td>
            <td>{$row['idhuella']}</td><td>{$row['ngabinete']}</td><td>{$row['fecha']}</td>
          </tr>";
}
echo "</table>";

// Formulario para controlar el relÃ© (encender / apagar)
echo "<h2>ğŸ’¡ Control de Luz</h2>";
echo "<form action='' method='get'>
        <button type='button' onclick=\"toggleRelay('on')\">Encender Luz</button>
        <button type='button' onclick=\"toggleRelay('off')\">Apagar Luz</button>
      </form>";

?>

<script>
  // FunciÃ³n para encender y apagar el relÃ©
  function toggleRelay(state) {
    const esp32_ip = "192.168.197.143"; // IP del ESP32
    fetch(`http://${esp32_ip}/toggle_relay?state=${state}`)
      .then(response => response.text())
      .then(data => {
        alert(data);
      })
      .catch(error => console.error('Error:', error));
  }
</script>

<?php
$conn->close();
?>

</body>
</html>

